{% extends "base.html" %}
{% block title %}Passport Verification{% endblock %}


{% block content %}
<div class="text-center mb-5">
    <h1>Passport Verification Service</h1>
    <p>Easily extract information and verify passport identity with AI-powered tools.</p>
</div>

<div class="card">
    <div class="card-header">
        <div class="nav-tabs">
            <button class="nav-link active" data-tab="extraction">Passport Information Extraction</button>
            <button class="nav-link" data-tab="verification">Passport Verification</button>
        </div>
    </div>
    <div class="card-body">
        <div class="tab-content">
            <div class="tab-pane active" id="extraction">
                <form id="extraction-form" action="/extraction" method="post" enctype="multipart/form-data">
                    <div>
                        <label for="passport_img_extraction" class="form-label">Upload Passport Image</label>
                        <input class="form-control" type="file" id="passport_img_extraction" name="passport_img" required>
                    </div>
                    <button type="submit" class="btn">
                        <span class="spinner-border"></span>
                        Extract Information
                    </button>
                </form>
                <div id="extraction-result">
                    {% if extraction_output %}
                    <div class="mt-4">
                        <h5>Extraction Result:</h5>
                        <table class="table table-bordered">
                            <tbody>
                                {% for key, value in extraction_output.items() %}
                                <tr>
                                    <th>{{ key.replace('_', ' ') | title }}</th>
                                    <td>{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% if extraction_error %}
                    <div class="alert alert-danger mt-4">
                        {{ extraction_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="tab-pane" id="verification">
                <form id="verification-form" action="/verification" method="post" enctype="multipart/form-data">
                    <div>
                        <label for="passport_img_verification" class="form-label">Upload Passport Image</label>
                        <input class="form-control" type="file" id="passport_img_verification" name="passport_img" required>
                    </div>
                    <div>
                        <label for="capture_img" class="form-label">Upload Your Image</label>
                        <input class="form-control" type="file" id="capture_img" name="capture_img" required>
                    </div>
                    <button type="submit" class="btn">
                        <span class="spinner-border"></span>
                        Verify
                    </button>
                </form>
                <div id="verification-result">
                    {% if verification_result %}
                    <div class="mt-4 text-center">
                        <h5>Verification Result:</h5>
                        {% if verification_result.is_match %}
                        <div class="alert alert-success">
                            Face matched! Similarity: {{ "%.2f"|format(verification_result.confidence_score) }}%
                        </div>
                        {% else %}
                        <div class="alert alert-danger">
                            Face not matched!
                        </div>
                        {% endif %}
                        
                        {% if verification_result.detected_face %}
                        <div class="mt-3">
                            <h6>Detected Face from Passport:</h6>
                            <img src="{{ verification_result.detected_face }}" class="detected-face-img" alt="Detected Face">
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if verification_error %}
                    <div class="alert alert-danger mt-4">
                        {{ verification_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.nav-link');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const target = tab.getAttribute('data-tab');
                tabPanes.forEach(pane => {
                    if (pane.id === target) {
                        pane.classList.add('active');
                    } else {
                        pane.classList.remove('active');
                    }
                });
            });
        });

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const button = form.querySelector('button[type="submit"]');
            const spinner = button.querySelector('.spinner-border');
            const resultDivId = form.id === 'extraction-form' ? 'extraction-result' : 'verification-result';
            const resultDiv = document.getElementById(resultDivId);

            button.classList.add('loading');
            button.disabled = true;
            resultDiv.innerHTML = '';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                });

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newResult = doc.getElementById(resultDivId).innerHTML;
                resultDiv.innerHTML = newResult;

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger mt-4" role="alert">An unexpected error occurred.</div>`;
                console.error('Error:', error);
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        document.getElementById('extraction-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('verification-form').addEventListener('submit', handleFormSubmit);
    });
</script>

{% endblock %}
