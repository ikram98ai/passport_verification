{% extends "base.html" %}
{% block title %}Passport Verification{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h1 class="fw-bold">Passport Verification Service</h1>
    <p class="lead">Easily extract information and verify passport identity with AI-powered tools.</p>
</div>

<div class="vstack gap-4 align-items-center">
    <div class="w-75">
        <div class="card h-100">
            <div class="card-header fw-semibold">Passport Information Extraction</div>
            <div class="card-body">
                <form id="extraction-form" action="/extraction" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="passport_img_extraction" class="form-label">Upload Passport Image</label>
                        <input class="form-control" type="file" id="passport_img_extraction" name="passport_img" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Extract Information
                    </button>
                </form>
                <div id="extraction-result">
                    {% if extraction_output %}
                    <div class="mt-4">
                        <h5 class="fw-semibold">Extraction Result:</h5>
                        <table class="table table-bordered">
                            <tbody>
                                {% for key, value in extraction_output.items() %}
                                <tr>
                                    <th scope="row" class="w-25">{{ key.replace('_', ' ') | title }}</th>
                                    <td>{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% if extraction_error %}
                    <div class="alert alert-danger mt-4" role="alert">
                        {{ extraction_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="w-75">
        <div class="card h-100">
            <div class="card-header fw-semibold">Passport Verification</div>
            <div class="card-body">
                <form id="verification-form" action="/verification" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="passport_img_verification" class="form-label">Upload Passport Image</label>
                        <input class="form-control" type="file" id="passport_img_verification" name="passport_img" required>
                    </div>
                    <div class="mb-3">
                        <label for="capture_img" class="form-label">Upload Your Image</label>
                        <input class="form-control" type="file" id="capture_img" name="capture_img" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Verify
                    </button>
                </form>
                <div id="verification-result">
                    {% if verification_result %}
                    <div class="mt-4 text-center">
                        <h5 class="fw-semibold">Verification Result:</h5>
                        {% if verification_result.is_match %}
                        <div class="alert alert-success" role="alert">
                            Face matched! Similarity: {{ "%.2f"|format(verification_result.confidence_score) }}%
                        </div>
                        {% else %}
                        <div class="alert alert-danger" role="alert">
                            Face not matched!
                        </div>
                        {% endif %}
                        
                        {% if verification_result.detected_face %}
                        <div class="mt-3">
                            <h6 class="fw-semibold">Detected Face from Passport:</h6>
                            <img src="{{ verification_result.detected_face }}" class="img-fluid rounded" alt="Detected Face">
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if verification_error %}
                    <div class="alert alert-danger mt-4" role="alert">
                        {{ verification_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('extraction-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const spinner = button.querySelector('.spinner-border');
        const resultDiv = document.getElementById('extraction-result');

        spinner.classList.remove('d-none');
        button.disabled = true;
        resultDiv.innerHTML = '';

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
            });

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newResult = doc.getElementById('extraction-result').innerHTML;
            resultDiv.innerHTML = newResult;

        } catch (error) {
            resultDiv.innerHTML = '<div class="alert alert-danger mt-4" role="alert">An unexpected error occurred.</div>';
            console.error('Error:', error);
        } finally {
            spinner.classList.add('d-none');
            button.disabled = false;
        }
    });

    document.getElementById('verification-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const spinner = button.querySelector('.spinner-border');
        const resultDiv = document.getElementById('verification-result');

        spinner.classList.remove('d-none');
        button.disabled = true;
        resultDiv.innerHTML = '';

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
            });

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newResult = doc.getElementById('verification-result').innerHTML;
            resultDiv.innerHTML = newResult;

        } catch (error) {
            resultDiv.innerHTML = '<div class="alert alert-danger mt-4" role="alert">An unexpected error occurred.</div>';
            console.error('Error:', error);
        } finally {
            spinner.classList.add('d-none');
            button.disabled = false;
        }
    });
</script>
{% endblock %}